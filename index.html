<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PWA Kamasutra Viewer (GitHub Pages)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background: #0b1220; color: #fff; }
    button { margin: 5px; padding: 10px; border-radius: 6px; border: none; background: #7c3aed; color: #fff; cursor: pointer; }
    #viewer { display: none; margin-top: 20px; padding: 15px; background: #1a1f36; border-radius: 8px; }
    #viewer img { max-width: 100%; border-radius: 6px; margin-bottom: 10px; }
    #status { margin-top: 10px; font-size: 14px; color: #9aa4b2; }
  </style>
</head>
<body>
  <h1>PWA Kamasutra Viewer</h1>
  <p><b>Fonctionnement :</b> les descriptions et les images sont chargées directement depuis le site et mises en cache offline automatiquement.</p>

  <div>
    <button id="btnLoadAll">Charger tout</button>
    <button id="btnShowRandom">Afficher une position aléatoire</button>
  </div>

  <div id="status">En attente…</div>

  <div id="viewer">
    <img id="viewerImage" src="" alt="">
    <h2 id="viewerTitle"></h2>
    <p id="viewerDesc"></p>
  </div>

<script>
const state = { descriptions: {}, images: [] };

async function loadAll(){
  try {
    const res = await fetch('descriptions.json?v='+Date.now(), {cache:'no-store'});
    const json = await res.json();
    const map = {};
    json.images.forEach(item => {
      map[item.filename.toLowerCase()] = item.description;
    });
    state.descriptions = map;

    // Charger images directement depuis le dossier "images/"
    state.images = json.images.map(item => ({
      fileName: item.filename.toLowerCase(),
      url: "./images/" + item.filename
    }));

    setStatus("Descriptions et images chargées ("+state.images.length+")");
  } catch(e) {
    setStatus("Erreur : " + e.message);
  }
}

function showRandom(){
  if(!state.images.length) return setStatus("Aucune image disponible.");
  const idx = Math.floor(Math.random()*state.images.length);
  const img = state.images[idx];
  const desc = state.descriptions[img.fileName] || "Pas de description trouvée";
  showViewer(img.fileName, img.url, desc);
}

function showViewer(title, src, desc){
  document.getElementById('viewerImage').src = src;
  document.getElementById('viewerTitle').textContent = title;
  document.getElementById('viewerDesc').textContent = desc;
  document.getElementById('viewer').style.display = 'block';
  setStatus("Affichage de : " + title);
}

function setStatus(msg){ document.getElementById('status').textContent = msg; console.log(msg); }

document.getElementById('btnLoadAll').addEventListener('click', loadAll);
document.getElementById('btnShowRandom').addEventListener('click', showRandom);

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log("SW ok"));
}
</script>
</body>
</html>
